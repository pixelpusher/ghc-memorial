<!DOCTYPE html>
<html lang="en">
	<head>
    <title>Spreadsheets via sheetrock using IDs to search</title>

  <!--  <link rel="stylesheet" type="text/css" href="http://chriszarate.github.io/sheetrock/src/sheetrock.min.css">!-->
        
    <style type="text/css">
    	#loading {
    		font-size: 36px;
    		font-weight: bold;
    	}
        #people, #person, #next25 {
            display:none;
        }
        #next25 {
            margin: 2em 1em;
            font-weight: bold;
        }
    </style>

    <script type="text/javascript">
        // This version is different because it uses the HTTP GET variable (the
        // bit after the ? in the url) to search the database, so you can pass
        // in a single id to search for
        
        // this function extracts the variable names and values from a url
        // such as "http://blahbalh.com/somepage.html?param1=34&param2=blahblah"
        // which gives 'param1' with a value of '34'
        // and 'param2' with a value of 'blahblah'

        // taken from: http://stackoverflow.com/questions/439463/how-to-get-get-and-post-variables-with-jquery
        
        function getQueryParams(qs) {
            qs = qs.split("+").join(" ");
            var params = {},
                tokens,
                re = /[?&]?([^=]+)=([^&]*)/g;
            
            while (tokens = re.exec(qs)) {
                params[decodeURIComponent(tokens[1])]
                    = decodeURIComponent(tokens[2]);
            }

            return params;
        }
            
        //
        // this function returns the GET variables passed in via the url
        //
        var $_GET = getQueryParams(document.location.search);
            
        // this function loads (or re-loads) everything from the database.
        var loadDatabase = function()
    	{
            var id = parseInt($_GET['id'],10); // get the id, make sure it is a number!
            
            // check if id is a proper number (NaN means 'Not a Number')
            var idIsGood = !(id == undefined || isNaN(id)); 
            
            //console.log(id);
            
            // the Handlebars template for HR leaders.
            var HTemplate;
            
            var query;  // this is what sheetrock will use to search the database
            
            var targetElem; // the html id to load into
            
            var finishedLoading = function() { 
                    targetElem.css('display','block'); 
            };
            
        
            if (!idIsGood) 
            {
                console.log('id was bad');
                // if no id was given, or it was not a number, return all rows
                query = "select %id%, %surname%, %forenames%, %cemeterymemorial% order by %surname% asc";
                targetElem = $('#people');
                HTemplate = Handlebars.compile($('#people-template').html());  
                
                $('#next25').css('display', 'block');
            }
            else
            {
                console.log('id was good');
                // if we found the id, do a search
                //query = "select %id%, %surname%, %forenames%, %cemeterymemorial% where %id%="+id+" order by %surname% asc";
                query = "select * where %id%="+id;
                targetElem = $('#person');
                HTemplate = Handlebars.compile($('#person-template').html());  
            }
            
            
    		// Define spreadsheet URL.
			var mySpreadsheet = 'https://docs.google.com/spreadsheet/ccc?key=1qM3kEVwzSg9sgYVfhibaF5jQdiw3E40ZVtaukCZugX4#gid=0';
			console.log('loading');
			// Load an entire sheet.
			targetElem.sheetrock({
				url: mySpreadsheet,
                sql: query,                
  				chunkSize: 25, // 300 rows
                headersOff: true,
                rowHandler: HTemplate,
  				loading: $('#loading'),
                userCallback : finishedLoading
			});  
    	};
            
        window.addEventListener('load', loadDatabase);
    </script>
  
 	</head>
	
	<body>

		<p>This example shows how to get either a single entry from the database,
            or a number of entries that can be clicked on.  Initially, the target
            DIVs that hold either a single person's data or multiple people's data
            are hidden, and if an id is provided via HTTP GET (see javascript comments)
            it fetches a single row of data for that id and unhides the Person DIV,
            otherwise it gets all the rows of data and unhides the People DIV.</p>

		<div id="loading">Loading...</div>
		
        <div id="person">
        <h2>Person:</h2>
        <script id="person-template" type="text/x-handlebars-template">    
            <div class="name"><strong>
              {{#if cells.surname}}
                {{cells.surname}}
              {{else}}
                ?
              {{/if}},
              
              {{#if cells.forenames}}
                {{cells.forenames}}
              {{else}}
                ?
              {{/if}}
                </strong>
            </div>
            <div class="info">
                <ol>
                    <li>{{cells.age}}</li>
                    <li>{{cells.date_of_death}}</li>
                    <li>{{cells.cemeterymemorial}}</li>
                    <li>{{cells.regiment}}</li>
                </ol>
            </div>
        </script>
        </div>
            
        <div id="people">
        <h2>People</h2>
        <table class="table table-condensed table-striped">
        <thead>
        <tr>
            <th>Surname, Forename</th>
            <th>Cemetery</th>
        </tr>
        </thead>
        <tbody id="people_table">
          <script id="people-template" type="text/x-handlebars-template">
            <tr>
                <td>
              <a href="?id={{cells.id}}">
                  <strong>
                  {{#if cells.surname}}
                    {{cells.surname}}
                  {{else}}
                    ?
                  {{/if}},
                  
                  {{#if cells.forenames}}
                    {{cells.forenames}}
                  {{else}}
                    ?
                  {{/if}}
                  </strong></a></td>
                <td>{{cells.cemeterymemorial}}</td>
            </tr>
          </script>
        </tbody>
        </table>
        </div>
        
        <div id="next25"><a href="javascript:loadDatabase();">next 25</a></div>
        
        
        
	<!-- https://docs.google.com/spreadsheets/d/1Nn50GZXtwhDZVIiOqFBgsQ40N6gyPHyz0yYiJDiByrs/pubhtml -->

    <!-- https://docs.google.com/spreadsheets/d/1qM3kEVwzSg9sgYVfhibaF5jQdiw3E40ZVtaukCZugX4/edit?usp=sharing -->
     
    <!-- Load jQuery from CloudFlare’s CDN. -->
	<script src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.1.2/handlebars.min.js"></script>

    <!-- Load jQuery from CloudFlare’s CDN. -->
	<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

	<!-- sheetrock for google spreadsheets API -->
    <!--<script src="http://chriszarate.github.io/sheetrock/src/jquery.sheetrock.min.js"></script>!-->

        <script src="/js/jquery.sheetrock.min.js"></script> 
  </body>
</html>